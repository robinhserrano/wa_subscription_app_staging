import{s as ce}from"./index-BHpc1ofO.js";import{d as Pe,s as ue,a as _,b as ve,c as _e,e as I,f as We,g as Me,h as ze,i as qe,j as me,k as pe,l as Ge}from"./primeicons-Bv4LIbxA.js";import{s as Ke}from"./index-CswI-Ay3.js";import{p as Qe,q as He,d as c,s as Je,x as ye,y as U,z as Ye,A as he,B as Xe,o as a,e as u,a as r,g as y,t as d,f as p,b as i,w as n,u as s,F as Q,h as H,c as b,l as L,C as fe,D as be}from"./app-CwFhXn1o.js";import{u as N}from"./xlsx-YQvpTstd.js";const Ze={class:"card"},et={class:"m-4 my-4"},tt={key:0},lt=r("i",{class:"pi pi-calendar"},null,-1),st={key:1},ot=r("i",{class:"pi pi-map-marker"},null,-1),it=r("i",{class:"pi pi-user"},null,-1),rt=r("i",{class:"pi pi-map-marker mt-2"},null,-1),at=r("p",{class:"mt-6"}," Order Lines:",-1),dt={key:0},nt=r("p",{class:"mt-6 mb-2"}," Other Address:",-1),ct=r("i",{class:"pi pi-building-columns"},null,-1),ut=r("p",{class:"mt-6 mb-2"}," Other Address:",-1),vt=r("i",{class:"pi pi-building"},null,-1),_t=r("p",{class:"mb-2 text-xl font-bold"},"States",-1),mt=["for"],pt=r("p",{class:"mt-4 mb-2 text-xl font-bold"},"Activity Summary",-1),yt=["for"],ht={class:"font-bold"},ft={class:"flex justify-between"},bt=r("i",{class:"pi pi-search"},null,-1),kt={style:{display:"flex","align-items":"center"}},gt=["onClick"],St=["onClick"],wt={class:"flex items-center"},Ct={key:0},Dt={key:1,class:"pi pi-truck ml-2"},$t={class:"flex items-center"},It={key:0,class:"flex align-items-center"},Ut={key:0},Ft={key:1},Vt={key:1},xt={class:"flex align-items-center"},At=["src"],Ot={class:"flex items-center"},Tt={key:0,class:"flex align-items-center"},Rt={key:0},Bt={key:1},jt={key:0},Et={key:2},Lt={key:0},Nt={key:3},Pt={key:1},Wt={class:"flex align-items-center"},Mt={key:0,class:"ml-1"},zt=["src"],Jt={__name:"SubsToDeliverDataTable",props:{filterSubs:Object,stateIds:Object,deliverSubIds:Object,currentUser:Object,users:Object,serviceCodes:Object,filters:Object},setup(k){const ke=Qe(),g=He(),J=c(1),x=c([]),Y=c([]),F=c(),P=c(!0),ge=c(),A=c([]),X=c([]),Z=c(),Se=c([]),ee=c(),h=c([]),W=c(100),O=c(),M=c(),te=c(),C=c([]),z=c([]),T=c([]),R=c(0),q=c(!1),G=c(!1),le=c(),we=c([{id:1,name:"Send 1st Stage Filter"},{id:2,name:"Independent 3 + 3 Due for Change"},{id:3,name:"Independent 3 + 3 Expires"},{id:4,name:"3 + 3 Stage Filter"},{id:5,name:"3 Stage Filter"},{id:6,name:"3 + 3 Stage Filter Expires"},{id:7,name:"3 Stage Filter Expires"},{id:8,name:"Final Date to Order Filters for Warranty Extension"}]),Ce=c([{name:"Delivery Booked",value:"Delivery Booked"},{name:"- Unselect -",value:null}]);let S=k;Je(()=>{P.value=!1,R.value=S.filterSubs.total,ge.value=S.salesQuotations,T.value=S.stateIds,z.value=S.serviceCodes.map(t=>({name:t.service_code,value:t.id,totalWeight:t.total_weight})),z.value.push({name:"- Unselect -",value:null,totalWeight:null})});const se=()=>{F.value={start_date:{operator:fe.AND,constraints:[{value:null,matchMode:be.DATE_IS}]},due_date:{operator:fe.AND,constraints:[{value:null,matchMode:be.DATE_IS}]}}};se(),ye(M,async t=>{if(t)try{const l=await U.get("/api/findSalesOrdersBySalesOrderNo",{params:{sales_order_no:t}});Y.value=l.data.map(m=>({name:m.sales_order_no,value:m.sales_order_no})),Y.value.push({name:"- Unselect -",value:null})}catch(l){console.error("Error fetching dropdown options:",l)}}),ye([()=>x.value,()=>C.value,()=>A.value,()=>X.value,()=>F.value],()=>{D()});const De=()=>{se()},$e=async t=>{var m,$;const l={"Record Type":"recordType","Receiver Code":"receiverCode","Receiver Name":"customer_name","Receiver Address 1":"street","Receiver Address 2":"street2","Receiver Address 3":"receiverAddress3","Receiver Suburb":"city","Receiver Postcode":"zip","Receiver Contact":"receiverContact","Receiver Phone":"phone",Email:"email","Reference 1":"sales_order_no","Reference 2":"","Special Instructions":"","Service Code":"serviceCode","Number of Items":"numberOfItems","Total Weight":"totalWeight","Total Cubic Volume":"totalCubicVolume","Authority to Leave":"authorityToLeave"};try{const f=await U.post("/api/getDeliverySubByIds",{deliverSubIds:t});if(f.status===200){const e=f.data.deliverSubs.map(v=>{var ie,re,ae,de,ne;const E=((ie=v.contact_address)==null?void 0:ie[0])||{};v.recordType="C",v.receiverCode=null,v.street=E.street??"",v.street2=E.street2??"",v.receiverAddress3=null,v.city=E.city??"",v.zip=E.zip??"",v.receiverContact=v.customer_name||"",v.reference2=null,v.specialInstructions=null,v.serviceCode=((re=v.service_code)==null?void 0:re.service_code)||"",v.numberOfItems=((ae=v.service_code)==null?void 0:ae.number_of_items)||0,v.totalWeight=((de=v.service_code)==null?void 0:de.total_weight)||0,v.totalCubicVolume=((ne=v.service_code)==null?void 0:ne.total_cubic_volume)||0,v.authorityToLeave="Y";let oe={};for(const[Le,Ne]of Object.entries(l))oe[Le]=v[Ne];return oe}),o=N.json_to_sheet(e),w=N.book_new();N.book_append_sheet(w,o,"Sheet1");const B=N.sheet_to_csv(o),j=new Blob([B],{type:"text/csv;charset=utf-8;"}),Ee=URL.createObjectURL(j),V=document.createElement("a");V.href=Ee,V.setAttribute("download","subs_to_deliver.csv"),document.body.appendChild(V),V.click(),document.body.removeChild(V)}else g.error("Error: Unable to fetch delivery subscriptions.")}catch(f){g.error("Error: "+((($=(m=f.response)==null?void 0:m.data)==null?void 0:$.message)||"Network Error"))}},D=async()=>{try{var t=route().current("subscriptionsToDeliverFilterSubscription")?"/subscriptionsToDeliverFilterSubscription":"/subscriptionsToDeliver";const l=Ye.get(t,{page:J.value,search:le.value,dates:x.value,stateId:C.value,activitySummary:A.value,categories:X.value,perPage:W.value,filters:JSON.stringify(F.value)},{preserveState:!0,replace:!1,onSuccess:m=>{R.value=m.props.filterSubs.total}})}catch(l){console.error("Error fetching data:",l)}finally{P.value=!1}},Ie=Pe(D,300),K=t=>t?new Date(t).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}):null,Ue=t=>{if(!t||t.length===0)return"";const l=new Date(t[0]),m=t[1]?new Date(t[1]):l;return`${l.toLocaleDateString("en-PH",{day:"2-digit",month:"2-digit",year:"numeric"})} to ${m.toLocaleDateString("en-PH",{day:"2-digit",month:"2-digit",year:"numeric"})}`},Fe=t=>t.map(l=>{var m;return(m=T.value[l-1])==null?void 0:m.code}).join(", "),Ve=t=>{q.value=!0,M.value=t.sales_order_no,te.value=t.order_line,ee.value=t.customer_name,Z.value=t.address,Se.value=t.contact_address,O.value=t},xe=t=>{W.value=t.rows,J.value=t.page+1,D()},Ae=t=>{le.value=t.target.value,Ie()},Oe=async t=>{try{const l=await U.put(`/api/updateDeliveredOrDeliveryBooked/${t.id}`,{delivered_or_delivery_booked:t.delivered_or_delivery_booked.value,delivered_or_delivery_booked_by_id:S.currentUser.id});g.add({severity:"success",summary:`Updated #${t.sales_order_no} delivered or delivery booked status`,detail:"",life:3e3})}catch(l){console.error("Failed to update delivered_or_delivery_booked:",l),g.add({severity:"error",summary:"Failed Message",detail:"Message Content",life:3e3})}},Te=async t=>{try{const l=await U.put(`/api/updateServiceCode/${t.id}`,{service_code_id:t.service_code_id.value,service_code_updated_by_id:S.currentUser.id});g.add({severity:"success",summary:`Updated #${t.sales_order_no}'s service code`,detail:"",life:3e3}),D()}catch(l){console.error("Failed to update delivered_or_delivery_booked:",l),g.add({severity:"error",summary:"Failed Message",detail:"Message Content",life:3e3})}},Re=(t,l,m)=>{ke.require({message:`Do you want to unlink #${l} from #${t}?`,header:"Unlink Sales Order",icon:"pi pi-info-circle",rejectLabel:"Cancel",rejectProps:{label:"Cancel",severity:"secondary",outlined:!0},acceptProps:{label:"Unlink",severity:"danger"},accept:async()=>{await U.delete(`/api/deliverSub/${m}`),D(),g.add({severity:"info",summary:"Unlinked Successfully",detail:`Unlinked #${l} from #${t}`,life:3e3})},reject:()=>{}})},Be=async()=>{var t=h.value.map(m=>m.id);const l=JSON.stringify({deliverSubIds:t,delivered_or_delivery_booked_by_id:S.currentUser.id});await U.post("/api/bulkConfirmDeliveryBooked",l,{headers:{"Content-Type":"application/json"}}),g.add({severity:"success",summary:`Successfully confirmed ${t.length} filter subs`,detail:"",life:3e3}),D(),h.value=[]},je=async t=>{h.value=t};return(t,l)=>{const m=he("Toast"),$=he("font-awesome-icon"),f=Xe("tooltip");return a(),u("div",Ze,[r("div",null,[r("div",et,[x.value.length?(a(),u("div",tt,[lt,y(" "+d(Ue(x.value)),1)])):p("",!0),C.value.length?(a(),u("div",st,[ot,y(" "+d(Fe(C.value)),1)])):p("",!0)])]),i(m),i(s(ve),{visible:q.value,"onUpdate:visible":l[0]||(l[0]=e=>q.value=e),header:M.value,class:"!w-full md:!w-80 lg:!w-[30rem]"},{default:n(()=>[r("p",null,[it,y(" "+d(ee.value),1)]),r("p",null,[rt,y(" "+d(Z.value),1)]),at,i(s(ue),{value:te.value,dataKey:"id",showGridlines:"",class:"mt-2"},{default:n(()=>[i(s(_),{field:"product",header:"Product",style:{"min-width":"10rem"}}),i(s(_),{field:"description",header:"Description",style:{"min-width":"10rem"}}),i(s(_),{field:"quantity",header:"Quantity",style:{"min-width":"5rem"}})]),_:1},8,["value"]),r("div",null,[O.value.contact_address[0].parent?(a(),u("p",dt,[nt,ct,y(" "+d(O.value.contact_address[0].parent.complete_address),1)])):p("",!0)]),r("div",null,[(a(!0),u(Q,null,H(O.value.contact_address[0].children,(e,o)=>(a(),u("p",{key:o},[ut,vt,y(" "+d(e.complete_address),1)]))),128))])]),_:1},8,["visible","header"]),i(s(ve),{visible:G.value,"onUpdate:visible":l[3]||(l[3]=e=>G.value=e),header:"Filters",position:"right",class:"!w-full md:!w-80 lg:!w-[30rem]"},{default:n(()=>[_t,(a(!0),u(Q,null,H(T.value,e=>(a(),u("div",{key:e.id,class:"flex items-center mb-2"},[i(s(_e),{modelValue:C.value,"onUpdate:modelValue":l[1]||(l[1]=o=>C.value=o),inputId:e.state_id,name:"stateIds",value:e.state_id},null,8,["modelValue","inputId","value"]),r("label",{for:e.id,class:"ml-2"},d(e.name),9,mt)]))),128)),pt,(a(!0),u(Q,null,H(we.value,e=>(a(),u("div",{key:e.id,class:"flex items-center mb-2"},[i(s(_e),{modelValue:A.value,"onUpdate:modelValue":l[2]||(l[2]=o=>A.value=o),inputId:e.name,name:"category",value:e.name},null,8,["modelValue","inputId","value"]),r("label",{for:e.id,class:"ml-2"},d(e.name),9,yt)]))),128))]),_:1},8,["visible"]),h.value.length?(a(),b(s(I),{key:0,class:"ml-4",outlined:""},{default:n(()=>[r("p",ht,d(h.value.length),1),y("selected "),h.value.length<k.filterSubs.total?(a(),b(s(I),{key:0,label:`Select all ${k.deliverSubIds.length}`,onClick:l[4]||(l[4]=e=>je(k.deliverSubIds)),icon:"pi pi-arrow-right",class:"ml-4",severity:"info"},null,8,["label"])):p("",!0)]),_:1})):p("",!0),h.value.length?(a(),b(s(I),{key:1,label:`Export as Excel (${h.value.length})`,onClick:l[5]||(l[5]=e=>$e(h.value)),class:"ml-4"},null,8,["label"])):p("",!0),h.value.length?(a(),b(s(I),{key:2,label:`Mark All As Delivery Booked (${h.value.length})`,onClick:Be,icon:"pi pi-truck",class:"ml-4"},null,8,["label"])):p("",!0),i(s(We),{rows:W.value,totalRecords:R.value,rowsPerPageOptions:[10,25,50,100,R.value].sort((e,o)=>e-o),onPage:xe},{start:n(e=>[y(d(k.filterSubs.from)+"-"+d(k.filterSubs.to)+" / "+d(k.filterSubs.total),1)]),_:1},8,["rows","totalRecords","rowsPerPageOptions"]),i(s(ue),{selection:h.value,"onUpdate:selection":l[8]||(l[8]=e=>h.value=e),value:k.filterSubs.data,lazy:"",loading:P.value,tableStyle:"min-width: 50rem",showGridlines:"",dataKey:"id",filterDisplay:"menu",filters:F.value,"onUpdate:filters":l[9]||(l[9]=e=>F.value=e)},{header:n(()=>[r("div",ft,[i(s(I),{type:"button",icon:"pi pi-filter-slash",label:"Clear",outlined:"",onClick:l[6]||(l[6]=e=>De())}),i(s(Me),null,{default:n(()=>[i(s(ze),null,{default:n(()=>[bt]),_:1}),r("div",null,[i(s(I),{onClick:l[7]||(l[7]=e=>G.value=!0),label:"Filter",class:"mr-4"}),i(s(qe),{placeholder:"Keyword Search",onInput:Ae})])]),_:1})])]),empty:n(()=>[y(" No filterSubs found. ")]),loading:n(()=>[y(" Loading filterSubs data. Please wait. ")]),default:n(()=>[i(s(_),{selectionMode:"multiple",headerStyle:"width: 3rem"}),i(s(_),{field:"root_sales_order.sales_order_no",header:"Root Sales Order #",style:{"min-width":"10rem"}},{body:n(({data:e})=>[r("div",kt,[r("span",null,d(e.root_sales_order.sales_order_no),1),i(s(Ke)),r("div",{onClick:o=>Re(e.root_sales_order.sales_order_no,e.sales_order_no,e.id),style:{cursor:"pointer","margin-left":"8px"}},[i($,{icon:["fas","link-slash"],style:{color:"#800000"}})],8,gt)])]),_:1}),i(s(_),{field:"sales_order_no",header:"Sales Order No.",style:{"min-width":"10rem"}},{body:n(({data:e})=>[r("span",{onClick:o=>Ve(e),class:"cursor-pointer hover:underline"},d(e.sales_order_no),9,St),r("div",wt,[t.route().current("subscriptionsToDeliverFilterSubscription")?(a(),u("div",Ct,[e.hasCallOutService?L((a(),b($,{key:0,icon:["fas","toolbox"]},null,512)),[[f,"Filter Sub (Filter + Call Out Service)"]]):L((a(),b($,{key:1,icon:["fas","faucet"]},null,512)),[[f,"Filter Sub (Filter Only)"]])])):p("",!0),e.delivered_or_delivery_booked&&e.delivered_or_delivery_booked.value!==null?(a(),u("i",Dt)):p("",!0)])]),_:1}),i(s(_),{field:"",header:"Delivered or Delivery Booked",style:{"min-width":"10rem"}},{body:n(({data:e})=>[r("div",$t,[i(s(me),{modelValue:e.delivered_or_delivery_booked,"onUpdate:modelValue":o=>e.delivered_or_delivery_booked=o,options:Ce.value,filter:"",optionLabel:"name",placeholder:"Select Confirmation",class:"w-full md:w-14rem",onChange:o=>Oe(e)},{value:n(o=>{var w;return[o.value?(a(),u("div",It,[e.delivered_or_delivery_booked&&e.delivered_or_delivery_booked.value!==null?(a(),u("div",Ut,d(((w=e.delivered_or_delivery_booked)==null?void 0:w.name)||e.delivered_or_delivery_booked),1)):(a(),u("div",Ft,d(o.placeholder),1))])):(a(),u("span",Vt,d(o.placeholder),1))]}),option:n(o=>[r("div",xt,[r("div",null,d(o.option.name),1)])]),_:2},1032,["modelValue","onUpdate:modelValue","options","onChange"]),e.delivered_or_delivery_booked_by_id?L((a(),b(s(ce),{key:0,class:"ml-2",style:{"background-color":"#ffffff",color:"#ffffff"}},{default:n(()=>[r("img",{src:e.delivered_or_delivery_booked_by.profile_photo_url,alt:"User Initials"},null,8,At)]),_:2},1024)),[[f,`Last updated by:
${e.delivered_or_delivery_booked_by.name}`]]):p("",!0)])]),_:1}),i(s(_),{field:"",header:"Service Code",style:{"min-width":"10rem"}},{body:n(({data:e})=>[r("div",Ot,[i(s(me),{modelValue:e.service_code_id,"onUpdate:modelValue":o=>e.service_code_id=o,options:z.value,filter:"",optionLabel:"name",placeholder:"Select Code",class:"w-full md:w-14rem",onChange:o=>Te(e)},{value:n(o=>{var w,B,j;return[o.value?(a(),u("div",Tt,[e.service_code_id.name=="- Unselect -"&&e.service_code_id.value==null?(a(),u("div",Rt,d(o.placeholder),1)):e.service_code_id&&e.service_code_id.value==null?(a(),u("div",Bt,[r("div",null,d(e.service_code.service_code),1),e.service_code.total_weight?(a(),u("div",jt,"("+d(e.service_code.total_weight)+"kg) ",1)):p("",!0)])):e.service_code_id.value!==null?(a(),u("div",Et,[r("div",null,d(((w=e.service_code_id)==null?void 0:w.name)||""),1),(B=e.service_code_id)!=null&&B.totalWeight?(a(),u("div",Lt,"("+d((j=e.service_code_id)==null?void 0:j.totalWeight)+"kg) ",1)):p("",!0)])):(a(),u("div",Nt,d(o.placeholder),1))])):(a(),u("span",Pt,d(o.placeholder),1))]}),option:n(o=>[r("div",Wt,[r("div",null,d(o.option.name),1),o.option.totalWeight?(a(),u("div",Mt,"("+d(o.option.totalWeight)+"kg) ",1)):p("",!0)])]),_:2},1032,["modelValue","onUpdate:modelValue","options","onChange"]),e.service_code_updated_by_id?L((a(),b(s(ce),{key:0,class:"ml-2",style:{"background-color":"#ffffff",color:"#ffffff"}},{default:n(()=>[r("img",{src:e.service_code_updated_by.profile_photo_url,alt:"User Initials"},null,8,zt)]),_:2},1024)),[[f,`Last updated by:
${e.service_code_updated_by.name}`]]):p("",!0)])]),_:1}),i(s(_),{field:"customer_name",header:"Customer Name",style:{"min-width":"10rem"},filterField:"customer_name"}),i(s(_),{field:"address",header:"Delivery Address",style:{"min-width":"10rem"}}),i(s(_),{field:"activity_summary",header:"Activity Summary",style:{"min-width":"10rem"}}),i(s(_),{field:"start_date",header:"Start Date",style:{"min-width":"10rem"},filterField:"start_date",dataType:"date"},{body:n(({data:e})=>[y(d(K(e.start_date)),1)]),filter:n(({filterModel:e})=>[i(s(pe),{modelValue:e.value,"onUpdate:modelValue":o=>e.value=o,dateFormat:"dd/mm/yy",placeholder:"dd/mm/yyyy"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),i(s(_),{field:"due_date",header:"Due Date",style:{"min-width":"10rem"},filterField:"due_date",dataType:"date"},{body:n(({data:e})=>[y(d(K(e.due_date)),1)]),filter:n(({filterModel:e})=>[i(s(pe),{modelValue:e.value,"onUpdate:modelValue":o=>e.value=o,dateFormat:"dd/mm/yy",placeholder:"dd/mm/yyyy"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),i(s(_),{field:"invoice_number",header:"Invoice Number",style:{"min-width":"10rem"}}),i(s(_),{field:"invoice_date",header:"Invoice Date",style:{"min-width":"10rem"}},{body:n(({data:e})=>[y(d(K(e.invoice_date)),1)]),_:1}),i(s(_),{field:"state_id",header:"State",style:{"min-width":"10rem"}},{body:n(({data:e})=>{var o;return[y(d((o=T.value[e.state_id-1])==null?void 0:o.name),1)]}),_:1}),i(s(_),{field:"phone",header:"Phone",style:{"min-width":"10rem"}}),i(s(_),{field:"email",header:"Email",style:{"min-width":"10rem"}}),i(s(_),{field:"payment_status",header:"Payment Status",style:{"min-width":"10rem"}},{body:n(({data:e})=>[e.payment_status==="paid"?(a(),b(s(Ge),{key:0,severity:"success",value:"Paid"})):p("",!0)]),_:1})]),_:1},8,["selection","value","loading","filters"])])}}};export{Jt as _};
